{{ $docVersion := $.Scratch.Get "docVersion" }}
{{ $urlArray := split (urls.Parse .Permalink).Path "/" }}
{{ $previewUrl := path.Join "preview" (after 2 $urlArray) }}
{{ $previewUrl = add (add "/" $previewUrl) "/" }}
{{ $stableUrl := path.Join "stable" (after 2 $urlArray) }}
{{ $stableUrl = add (add "/" $stableUrl) "/" }}
{{ $previewVersion := "" }}
{{ $stableVersion := "" }}
{{ $previewBehindStable := false }}

{{ range .Site.Data.currentVersions.dbVersions }}
  {{- if eq .alias "stable" -}}
    {{ $stableVersion = .series -}}
    {{- if in .PreviewBehindStable true -}}
      {{ $previewBehindStable = true }}
    {{- end -}}
  {{- else if eq .alias "preview" -}}
    {{- $previewVersion = .series -}}
  {{- end -}}
{{- end -}}

{{- if not (and (eq $docVersion "stable") $previewBehindStable) -}}
  {{ range .Site.Data.currentVersions.dbVersions }}
      {{- if or (eq $docVersion .series) (eq $docVersion .alias)  -}}
        <div class="admonition {{if eq .alias "preview"}}warning{{else}}note{{end}}">
          {{- if or (eq .isLTS true) (eq .isSTS true) -}}
            <p>This page documents a stable (production) version. For testing and development with the latest features,
              use the <a href="{{ $previewUrl }}">preview ({{ $previewVersion }}) version.</a>
            {{ if not (eq .alias "stable") }}
            For the latest stable version, go to <a href="{{ $stableUrl }}">stable ({{ $stableVersion }})</a> version.
            {{ end }}
            </p>
          {{- else if eq .alias "preview" -}}
            <p>This page documents the preview ({{ $previewVersion }}) version that is to be used for testing and development with the
              latest features only. For production, use the <a href="{{ $stableUrl }}"> stable ({{ $stableVersion }})</a> version.</p>
          {{- else -}}
            {{- if $previewBehindStable -}}
              <p>This page documents an earlier version. Go to the <a href="{{ $stableUrl }}">stable ({{ $stableVersion }})</a> version.</p>
            {{- else -}}
              <p>This page documents an earlier version. Go to the <a href="{{ $previewUrl }}">preview ({{ $previewVersion }})</a> version.</p>
            {{- end -}}
          {{- end -}}
        </div>
      {{- end -}}
  {{- end -}}
{{- end -}}
