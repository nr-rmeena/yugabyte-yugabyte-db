{{/* Get the inner content of the shortcode */}}
{{ $statements :=  .Inner }}
{{/* type has to be one of [tabs, grammar, diagram, reference] (default:tabs) */}}
{{ $type := default "tabs" (.Get "type") }}

{{/* process inner content to remove whitespaces, newlines, commas, hypens etc */}}
{{/* statements will finally be rule1,rule2,rule3 ... */}}
{{ $statements = replaceRE "\\s*-\\s*" "," $statements }}
{{ $statements = replaceRE "\\s+" "," $statements }}
{{ $statements = replaceRE ",+" "," $statements }}
{{ $statements = trim $statements "," }}

{{/* localrefs are the rules to be anchored as #rule instead of grammar_diagrams#rule */}}
{{ $local := default "" (.Get "localrefs") }}
{{ $local = replaceRE "\\s+" "" $local }}
{{ $local = replaceRE ",+" "," $local }}

{{/* get the page path so determine depth and version */}}
{{ $path := split $.Page.File.Dir "/" }}
{{/* version is the first path of the path. eg: preview/stable/v2.12 ...*/}}
{{ $version := index $path 0 }}
{{ $depth := add 1 (len $path) }}

{{/* determine the api (ysql/ycql) from the page path */}}
{{ $api := "ysql" }}
{{ if strings.Contains $.Page.File.Dir "/ycql/" }}{{ $api = "ycql" }}{{ end }}

{{/* form the full service url with parameters */}}
{{ $url := "http://localhost:1314/ebnf" }}
{{ $url = printf "%s?depth=%d&api=%s&version=%s&rules=%s" $url $depth $api $version $statements}}
{{ if $local }}{{ $url = printf "%s&local=%s" $url $local }}{{ end }}
{{/* add a timestamp value to skip the hugo cache and force the request to be fetched */}}
{{/* if the regenerateDiagrams is set to true in config.toml, forcefully skip the cache by */}}
{{/* setting the ts value to current timestamp */}}
{{ if $.Site.Params.regenerateDiagrams }}
{{ $url = printf "%s&ts=%d" $url now.Unix }}
{{ else }}
{{/* set the ts value to the lastmod ts of the base ebnf file to use cache unless the file is changed */}}
{{ $f := os.Stat (printf "content/%s/api/%s/syntax_resources/%s_grammar.ebnf" $version $api $api) }}
{{ $url = printf "%s&ts=%d" $url $f.ModTime.Unix }}
{{ end }}

{{$bnfResponse := ""}}
{{- if eq $type "tabs" -}}
    {{/* counter for the no.of diagrams on the page, to name tabs differently for each tab pair */}}
    {{- $suffix := "" -}}
    {{ .Page.Scratch.Add "numdiagrams" 1 }}
    {{- $suffix = printf "-%d" (.Page.Scratch.Get "numdiagrams") -}}

    <ul class="nav nav-tabs nav-tabs-yb">
        <li >
        <a href="#grammar{{$suffix}}" class="nav-link" id="grammar-tab" data-toggle="tab" role="tab" aria-controls="grammar" aria-selected="true">
            <img src="/icons/file-lines.svg" alt="Grammar Icon">
            Grammar
        </a>
        </li>
        <li>
        <a href="#diagram{{$suffix}}" class="nav-link active" id="diagram-tab" data-toggle="tab" role="tab" aria-controls="diagram" aria-selected="false">
            <img src="/icons/diagram.svg" alt="Diagram Icon">
            Diagram
        </a>
        </li>
    </ul>

    <div class="tab-content">
        <div id="grammar{{$suffix}}" class="tab-pane fade" role="tabpanel" aria-labelledby="grammar-tab">
            {{- $bnfResponse = resources.GetRemote (printf "%s&mode=grammar" $url) -}}
            {{- print "```output.ebnf\n" $bnfResponse.Content "\n``` " | markdownify -}}
        </div>
        <div id="diagram{{$suffix}}" class="tab-pane fade show active" role="tabpanel" aria-labelledby="diagram-tab">
            {{- $bnfResponse = resources.GetRemote (printf "%s&mode=diagram" $url) -}}
            {{- print $bnfResponse.Content | markdownify -}}
        </div>
    </div>

{{- else if eq $type "grammar" -}}
    {{/* set the mode to be grammar to fetch only the grammar */}}
    {{- $bnfResponse = resources.GetRemote (printf "%s&mode=grammar" $url) -}}
    {{- print "```output.ebnf\n" $bnfResponse.Content "\n``` " | markdownify -}}

{{- else if eq $type "diagram" -}}
    {{/* set the mode to be diagram to fetch only the diagram */}}
    {{- $bnfResponse = resources.GetRemote (printf "%s&mode=diagram" $url) -}}
    {{- print $bnfResponse.Content | markdownify -}}

{{- else if eq $type "reference" -}}
    {{/* set the mode to be reference to generate the reference file */}}
    {{- $bnfResponse = resources.GetRemote (printf "%s&mode=reference" $url) -}}
    {{- print $bnfResponse.Content | markdownify -}}

{{- else -}}
    {{- errorf "invalid type for ebnf: %s" $type }}

{{- end -}}
