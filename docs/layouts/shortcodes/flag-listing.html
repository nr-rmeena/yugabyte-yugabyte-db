{{/*
Outputs a table of all known master or tserver flags.

Syntax:
  {{% flag-listing [process] [flag-type] %}}

  * process is either "master" or "tserver". Default is master.
  * flag-type is "all" or "runtime". Default is all.

Example:

{{% flag-listing "master" %}}

TROUBLESHOOTING

  * If you get an error like this:
      "execute of template failed at <transform.Unmarshal>: error calling Unmarshal: no data to transform",
    The most likely reason is that $remoteUrl is incorrect.

  * If you get the "no version name!" error, check params.toml for problems in the [[versions]] entries.
*/}}

{{ $process := default "master" (.Get 0) }}
{{ $flagType := default "all" (.Get 1) }}
{{ $versionName := .Site.Params.version_menu }}
{{ $pagePermalink := .Page.RelPermalink }}
{{ $remoteUrl := "https://raw.githubusercontent.com/yugabyte/yugabyte-db/master/managed/src/main/resources/gflags_metadata/2.17/" }}

{{/* Cut the version name down to just a number. */}}
{{/* (This part will need redoing when we start using per-build flag lists.) */}}
{{ range .Site.Params.versions }}
  {{ if hasPrefix $pagePermalink .url }}
    {{ $versionName = .version }}
    {{- if in .version "(Preview)" -}}
      {{ $versionName = replace .version " (Preview)" "" }}
    {{- else if in .version "(STS)" -}}
      {{ $versionName = replace .version " (STS)" "" }}
    {{- else if in .version "(LTS)" -}}
      {{ $versionName = replace .version " (LTS)" "" }}
    {{ end }}
  {{ end }}
  {{- if in $versionName "v" -}}
    {{ $versionName = replace $versionName "v" "" }}
  {{- end -}}
{{ end }}

{{/* Add the version and filename to the remote URL */}}
{{/* (This part will need redoing when we start using per-build flag lists.) */}}
{{- if $versionName -}}
  {{ $remoteUrl =  replace $remoteUrl "2.17" $versionName }}
  {{ $remoteUrl = printf "%s%s.xml" $remoteUrl $process }}
{{ else }}
  {{ errorf "something went wrong in %s shortcode: no version name! %s" .Name .Position }}
{{ end }}

{{/* Get the remote XML file and load it up as an array. Then, build the table. */}}

{{ if eq $flagType "all" }}

  {{ with resources.GetRemote $remoteUrl | transform.Unmarshal }}

<p>The following table lists {{ $flagType }} flags for <a href="/v{{ $versionName }}/reference/configuration/{{.program}}/">{{ .program }}</a> version {{ $versionName }}</p>

<table>
  <thead>
    <th>GFlag</th>
    <th>Description</th>
    <th>Default value</th>
  </thead>
  <tbody>

    {{/* Iterate over each GFlag record and check for tags we don't want. */}}
    {{ range .flag }}
      {{ $publish := true }}
      {{ with split .tags "," }}
        {{ range . }}
          {{/* See if anything says testing or unsafe or hidden. */}}
          {{/* If yes, break out of this range iteration to stop processing this GFlag. */}}
          {{/* If no, continue checking the tags. */}}
          {{ if or (eq . "hidden") (eq . "unsafe") (eq . "testing") }}
            {{ $publish = false }}
            {{ break }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{/* If this GFlag doesn't have any bad tags, publish it in a table row. */}}
      {{ if $publish }}
  <tr>
    <td><code>{{ .name | plainify | htmlUnescape }}</code> ({{ .type | plainify | htmlUnescape }})
    {{- if .tags -}}<br/><strong>Tags: </strong><em>{{ .tags | plainify | htmlUnescape }}</em>{{- end -}}
    </td>
    <td>{{ .meaning | plainify | htmlUnescape }}</td>
    <td>{{ .default | plainify | htmlUnescape }}</td>
  </tr>
      {{ end }}
    {{ end }}
  </tbody>
</table>
  {{ end }}

{{ end }}

{{ if eq $flagType "runtime" }}
  {{ with resources.GetRemote $remoteUrl | transform.Unmarshal }}

<p>The following table lists {{ $flagType }} flags for <a href="/v{{ $versionName }}/reference/configuration/{{.program}}/">{{ .program }}</a> version {{ $versionName }}</p>

<table>
  <thead>
    <th>Runtime GFlag</th>
    <th>Description</th>
    <th>Default value</th>
  </thead>
  <tbody>

    {{/* Iterate over each GFlag record and check for tags we don't want. */}}
    {{ range .flag }}
      {{ $publish := false }}
      {{ with split .tags "," }}
        {{ range . }}
          {{ if eq . "runtime" }}
            {{ $publish = true }}
            {{/*
              If this GFlag has a "runtime" tag, that's good, but let's
              keep going in case it's also got a tag we don't want.
            */}}
          {{ else if or (eq . "testing") (eq . "unsafe") (eq . "hidden") }}
            {{/* See if anything says testing or unsafe or hidden. */}}
            {{/* If yes, break out of this range iteration to stop processing this GFlag. */}}
            {{/* If no, continue checking the tags. */}}
            {{ $publish = false }}
            {{ break }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{/* If this GFlag doesn't have any bad tags, publish it in a table row. */}}
      {{ if $publish }}
<tr>
  <td><code>{{ .name | plainify | htmlUnescape }}</code> ({{ .type | plainify | htmlUnescape }})
  {{- if .tags -}}<br/><strong>Tags: </strong><em>{{ .tags | plainify | htmlUnescape }}</em>{{- end -}}
  </td>
  <td>{{ .meaning | plainify | htmlUnescape }}</td>
  <td>{{ .default | plainify | htmlUnescape }}</td>
</tr>
      {{ end }}
    {{ end }}
  </tbody>
</table>
  {{ end }}
{{ end }}
